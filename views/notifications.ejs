<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
  <%- include('partials/head.ejs', { pageTitle: 'Notifications' }) %>
  <body class="bg-base-100 min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <main class="container mx-auto p-4 flex-grow">
      <input type="hidden" id="currentUserId" value="<%= currentUser._id %>">

      <header class="mb-4 flex items-center justify-between">
        <h1 class="text-2xl font-bold">Notifications</h1>
        <button id="markAllRead" class="btn btn-ghost btn-sm">Mark all as read</button>
      </header>

      <% if ((notifications || []).length === 0) { %>
        <div class="max-w-xl mx-auto bg-base-200 rounded-xl p-8 text-center">
          <div class="flex justify-center mb-3">🔔</div>
          <p>No notifications yet.</p>
        </div>
      <% } %>

      <ul id="notifList" class="space-y-2">
        <% (notifications || []).forEach(n => { %>
          <li class="p-3 rounded-xl border flex items-start gap-3 <%= n.read ? 'opacity-70' : '' %>"
              data-id="<%= n._id %>"
              data-ts="<%= n.createdAt.toISOString() %>">
            <div class="w-10 h-10 rounded-full bg-base-200 flex items-center justify-center shrink-0">
              <% if (n.type === 'match') { %>🎉
              <% } else if (n.type === 'like') { %>❤️
              <% } else if (n.type === 'favorite') { %>⭐
              <% } else if (n.type === 'wave') { %>👋
              <% } else if (n.type === 'superlike') { %>⚡
              <% } else { %>🔔<% } %>
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm">
                <% if (n.type === 'superlike') { %>
                  <span class="badge badge-warning mr-2">⚡ Super-like</span>
                <% } %>
                <%= n.message || (n.type.charAt(0).toUpperCase() + n.type.slice(1)) %>
              </div>
              <div class="text-[11px] opacity-60"><%= new Date(n.createdAt).toLocaleString() %></div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <% if (!n.read) { %>
                <form method="post" action="/notifications/<%= n._id %>/mark-read">
                  <button class="btn btn-ghost btn-xs">Mark read</button>
                </form>
              <% } %>
              <button class="btn btn-outline btn-xs dismiss-btn" data-id="<%= n._id %>">Dismiss</button>
            </div>
          </li>
        <% }) %>
      </ul>

      <div id="loadingMore" class="text-center py-4 opacity-70 hidden">Loading…</div>
    </main>

    <%- include('partials/footer.ejs') %>

    <!-- Scripts (CSP-safe order) -->
    <script src="/socket.io/socket.io.js" defer></script>
    <script src="/js/socket.io.js" defer></script>
    <script src="/js/page-notifications.js" defer></script>
  </body>
</html>
