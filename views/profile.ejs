<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
  <%- include('partials/head.ejs', { pageTitle: user.username + " Profile" }) %>
  <body data-theme="cupcake" class="bg-base-100 min-h-screen flex flex-col">
    <%- include('partials/navbar.ejs') %>

    <div class="container mx-auto p-4 flex-grow">

      <!-- Unified Success Flash (supports successMessage or success) -->
      <% const _success = (typeof successMessage !== 'undefined' && successMessage) ? successMessage : ((typeof success !== 'undefined' && success) ? success : null); %>
      <% if (_success) { %>
        <div class="alert alert-success shadow-lg max-w-2xl mx-auto my-6">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span><%= _success %></span>
          </div>
        </div>
      <% } %>

      <% if (isBlocked) { %>
        <div class="alert alert-error shadow-lg max-w-2xl mx-auto my-8">
          <div>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>This user is blocked. You cannot interact with a blocked user.</span>
          </div>
        </div>
      <% } else { %>

        <!-- Profile Card -->
        <div class="max-w-4xl mx-auto bg-base-200 p-8 rounded-2xl shadow-xl space-y-8">

          <!-- Header: Avatar + Basic Info -->
          <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
            <!-- Profile Picture -->
            <div class="relative w-48 h-48 md:w-64 md:h-64 rounded-full overflow-hidden shadow-lg border-4 border-primary">
              <% if (user.profile && user.profile.photos && user.profile.photos.length > 0) { %>
                <img src="<%= user.profile.photos[0] %>" alt="<%= user.username %>" class="w-full h-full object-cover">
              <% } else { %>
                <div class="w-full h-full bg-base-300 flex items-center justify-center text-gray-500">
                  <span>No Photo</span>
                </div>
              <% } %>
            </div>

            <!-- Profile Info -->
            <div class="flex-grow text-center md:text-left">
              <h1 class="text-4xl font-extrabold text-primary">
                <%= user.username %>
                <% if (user.profile && user.profile.age) { %>
                  , <span class="text-gray-600 font-normal"><%= user.profile.age %></span>
                <% } %>
              </h1>

              <!-- Premium / Free Tier label FOR THE VIEWED PROFILE -->
              <% if (user.isPremium) { %>
                <p class="text-green-600 font-bold text-lg">Premium Member ✅</p>
              <% } else { %>
                <p class="text-gray-600 font-medium">Free Tier User</p>
              <% } %>

              <% if (user.profile && user.profile.location) { %>
                <p class="text-xl text-gray-500"><%= user.profile.location %></p>
              <% } %>

              <!-- Action Buttons -->
              <div class="flex justify-center md:justify-start gap-4 mt-6">
                <!-- Message Button -->
                <a href="/chat/<%= user._id %>" class="btn btn-secondary btn-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                  </svg>
                  Message
                </a>

                <!-- Like Button -->
                <button class="btn btn-primary btn-lg like-btn" data-user-id="<%= user._id %>">
                  ❤️ Like
                </button>

                <!-- Dislike Button -->
                <button class="btn btn-ghost btn-circle btn-lg dislike-btn" data-user-id="<%= user._id %>">
                  ❌
                </button>
              </div>

              <!-- Report / Block Buttons -->
              <div class="mt-4 flex justify-center md:justify-start gap-4">
                <!-- Report Button (modal) -->
                <button class="btn btn-warning btn-outline btn-sm" onclick="document.getElementById('reportModal').showModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  Report
                </button>

                <!-- Block Button (modal) -->
                <button class="btn btn-error btn-outline btn-sm" onclick="document.getElementById('blockModal').showModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                  </svg>
                  Block
                </button>
              </div>
            </div>
          </div>

          <!-- About / Details -->
          <div class="mt-6 text-gray-700">
            <h3 class="text-2xl font-bold mb-2">About Me</h3>
            <p class="text-md mb-4"><%= (user.profile && user.profile.bio) ? user.profile.bio : 'No bio provided.' %></p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p><strong>Gender:</strong> <%= (user.profile && user.profile.gender) ? user.profile.gender : 'N/A' %></p>
                <p><strong>Age:</strong> <%= (user.profile && user.profile.age) ? user.profile.age : 'N/A' %></p>
                <p><strong>Lives in:</strong> <%= (user.profile && user.profile.location) ? user.profile.location : 'N/A' %></p>
                <p><strong>Marital Status:</strong> <%= (user.profile && user.profile.maritalStatus) ? user.profile.maritalStatus : 'N/A' %></p>
                <p><strong>Height:</strong> <%= (user.profile && user.profile.height) ? (user.profile.height + ' cm') : 'N/A' %></p>
              </div>
              <div>
                <p><strong>Body style:</strong> <%= (user.profile && user.profile.bodyStyle) ? user.profile.bodyStyle : 'N/A' %></p>
                <p><strong>Ethnicity:</strong> <%= (user.profile && user.profile.ethnicity) ? user.profile.ethnicity : 'N/A' %></p>
                <p><strong>Occupation:</strong> <%= (user.profile && user.profile.occupation) ? user.profile.occupation : 'N/A' %></p>
                <p><strong>Religion:</strong> <%= (user.profile && user.profile.religion) ? user.profile.religion : 'N/A' %></p>
                <p><strong>Languages:</strong> <%= (user.profile && user.profile.languages) ? user.profile.languages : 'N/A' %></p>
              </div>
            </div>
          </div>

          <!-- Photos -->
          <div class="divider">Photos</div>
          <div class="photo-gallery grid grid-cols-2 md:grid-cols-3 gap-4">
            <% if (user.profile && user.profile.photos && user.profile.photos.length > 0) { %>
              <% user.profile.photos.forEach(function(photo){ %>
                <img src="<%= photo %>" alt="Photo of <%= user.username %>" class="w-full h-48 object-cover rounded-xl shadow">
              <% }); %>
            <% } else { %>
              <div class="photo-placeholder col-span-full text-center text-gray-500 italic">
                <span>No photos available</span>
              </div>
            <% } %>
          </div>

        </div> <!-- /Profile Card -->
      <% } %> <!-- /if not blocked -->
    </div> <!-- /container -->

    <!-- Modals -->
    <dialog id="blockModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Block</h3>
        <p class="py-4">Are you sure you want to block this user? They will be permanently removed from your matches and dashboard.</p>
        <div class="modal-action">
          <form id="blockForm" action="/block/<%= user._id %>" method="POST">
            <button type="submit" class="btn btn-error">Block</button>
          </form>
          <button class="btn btn-ghost" onclick="document.getElementById('blockModal').close()">Cancel</button>
        </div>
      </div>
    </dialog>

    <dialog id="reportModal" class="modal">
      <div class="modal-box">
        <h2 class="font-bold text-lg">Report User</h2>
        <p class="py-4">Please provide a reason for reporting this user.</p>
        <form id="reportForm" action="/report/<%= user._id %>" method="POST">
          <textarea name="reason" class="textarea textarea-bordered w-full" placeholder="Reason for reporting" required></textarea>
          <div class="modal-action">
            <button type="submit" class="btn btn-primary">Submit Report</button>
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('reportModal').close()">Cancel</button>
          </div>
        </form>
      </div>
    </dialog>

    <%- include('partials/modals.ejs') %>
    <%- include('partials/footer.ejs') %>

    <!-- JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Like button
        document.querySelectorAll('.like-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/like/${userId}`, { method: 'POST' });
              const result = await response.json();
              if (result.status === 'match') {
                const matchModal = document.getElementById('matchModal');
                const matchedUser = document.getElementById('matchedUser');
                if (matchModal && matchedUser) {
                  matchedUser.innerText = result.message;
                  matchModal.showModal();
                }
              } else if (result.status === 'error') {
                showAlertModal('Error', result.message);
              } else {
                showAlertModal('Success', 'User liked!');
              }
            } catch (err) {
              console.error('Error liking user:', err);
              showAlertModal('Error', 'Failed to like user');
            }
          });
        });

        // Dislike button
        document.querySelectorAll('.dislike-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const userId = e.currentTarget.getAttribute('data-user-id');
            try {
              const response = await fetch(`/dislike/${userId}`, { method: 'POST' });
              const result = await response.json();
              if (result.status === 'error') {
                showAlertModal('Error', result.message);
              } else {
                showAlertModal('Success', 'User disliked!');
              }
            } catch (err) {
              console.error('Error disliking user:', err);
              showAlertModal('Error', 'Failed to dislike user');
            }
          });
        });
      });

      // Minimal modal helpers (safe if partial already defines similar helpers)
      function showAlertModal(title, message) {
        const modal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        if (modal && alertTitle && alertMessage) {
          alertTitle.innerText = title;
          alertMessage.innerText = message;
          modal.showModal();
        } else {
          alert(title + ": " + message);
        }
      }
    </script>
  </body>
</html>



